default:
  image: debian:testing
  tags:
    - bookworm

stages:
  - build

.build debian package:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH != "nomerge/collabora-gitlab-ci"
  tags:
    - ultra-heavyweight
  cache:
    when: on_success
    key: $CI_COMMIT_REF_SLUG
    paths:
      - ccache
  variables:
    DEBIAN_FRONTEND: noninteractive
    GIT_SUBMODULE_STRATEGY: normal
    ARCH: x86
    DEFCONFIG: defconfig
    ADDITIONAL_DEFCONFIG: ""
    ADDITIONAL_BUILD_CMD: ""
    CCACHE_BASEDIR: $CI_PROJECT_DIR
    CCACHE_DIR: $CI_PROJECT_DIR/ccache
  before_script:
    - echo Building $CI_COMMIT_REF_NAME, $CI_COMMIT_REF_SLUG
    - apt update
    - apt install -y devscripts
                     build-essential
                     crossbuild-essential-arm64
                     bc
                     bison
                     ccache
                     flex
                     rsync
                     kmod
                     cpio
                     libelf-dev
                     libssl-dev
    # Setup ccache
    - export PATH="/usr/lib/ccache:$PATH"
    - ccache -s
  script:
    - make $DEFCONFIG

    # Enable additional config fragments
    - echo "$ADDITIONAL_DEFCONFIG" > .config-fragment
    - cat .config-fragment
    - ./scripts/kconfig/merge_config.sh .config .config-fragment

    - make -j$(nproc) $ADDITIONAL_BUILD_CMD bindeb-pkg
    - mkdir artifacts && dcmd mv ../*.changes artifacts/
  artifacts:
    paths:
      - artifacts

build amd64 debian package:
  extends: .build debian package

build arm64 debian package:
  extends: .build debian package
  variables:
    ARCH: arm64
    CROSS_COMPILE: aarch64-linux-gnu-
    ADDITIONAL_BUILD_CMD: KBUILD_IMAGE=arch/arm64/boot/Image
